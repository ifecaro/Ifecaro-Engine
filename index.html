<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM 載入中...</title>
    <link rel="icon" type="image/x-icon" href="/img/icons/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/img/icons/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/icons/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link href="/assets/tailwind.css" rel="stylesheet">
    <script type="text/javascript" src="/assets/sw.js" async></script>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Ifecaro">
    <style>
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #1a1a1a;
            color: white;
            z-index: 9999;
        }

        .progress-container {
            width: 80%;
            max-width: 500px;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #333;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }

        .loading-text {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }

        #main {
            display: none;
        }
    </style>
</head>

<body>
    <div id="main"></div>
    <div class="loading-container" id="loadingContainer" style="display: none;">
        <h1 class="text-2xl font-bold mb-4">載入中...</h1>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            <div class="loading-text" id="loadingText">0%</div>
        </div>
    </div>

    <script>
        // 更新進度條
        function updateProgress(percent) {
            const progress = document.getElementById('progress');
            const loadingText = document.getElementById('loadingText');
            progress.style.width = `${percent}%`;
            loadingText.textContent = `${Math.round(percent)}%`;
        }

        // 載入 WASM
        const wasmUrl = "/{wasm_path}";
        const jsUrl = "/{js_path}";

        async function loadWasm() {
            try {
                // 檢查 Service Worker 是否已快取 WASM
                const cache = await caches.open('ifecaro-cache-v3');
                const cachedResponse = await cache.match(wasmUrl);

                if (!cachedResponse) {
                    // 如果沒有快取，顯示進度條
                    document.getElementById('loadingContainer').style.display = 'flex';
                }

                // 下載 WASM
                const response = await fetch(wasmUrl);
                if (!response.ok) throw new Error('WASM 檔案載入失敗');

                const contentLength = response.headers.get('content-length');
                const total = parseInt(contentLength, 10);
                let loaded = 0;

                const reader = response.body.getReader();
                const collectedChunks = [];

                function pump() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            return collectedChunks;
                        }

                        collectedChunks.push(value);
                        loaded += value.length;
                        const progress = (loaded / total) * 100;
                        updateProgress(progress);

                        return pump();
                    });
                }

                const chunks = await pump();
                const blob = new Blob(chunks);
                const bytes = await blob.arrayBuffer();

                // 載入 JavaScript 模組
                const { default: init } = await import(jsUrl);

                // 直接使用 init 函數
                const wasm = await init(bytes);

                // 載入完成後顯示主頁面
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('main').style.display = 'block';

                // 只在沒有 __wbindgen_start 或 main 函數時才調用
                if (!wasm.__wbindgen_start && !wasm.main) {
                    if (wasm.__wbindgen_start) {
                        wasm.__wbindgen_start();
                    } else if (wasm.main) {
                        wasm.main();
                    }
                }
            } catch (error) {
                console.error('載入失敗:', error);
                document.getElementById('loadingContainer').style.display = 'flex';
                document.querySelector('.loading-text').textContent = '載入失敗，請重新整理頁面';
            }
        }

        // 開始載入
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration('/')
                .then(registration => {
                    if (!registration) {
                        return navigator.serviceWorker.register('/sw.js', {
                            scope: '/'
                        });
                    }
                    return registration;
                })
                .then(registration => {
                    console.log('Service Worker 註冊成功:', registration);
                    // 在 Service Worker 註冊成功後開始載入 WASM
                    loadWasm();
                })
                .catch(error => {
                    console.error('Service Worker 註冊失敗:', error);
                    // 即使 Service Worker 註冊失敗，也嘗試載入 WASM
                    loadWasm();
                });
        } else {
            // 如果瀏覽器不支援 Service Worker，直接載入 WASM
            loadWasm();
        }
    </script>
</body>

</html>