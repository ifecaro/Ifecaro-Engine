server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location = /staging {
        return 302 /staging/;
    }

    # Canonicalize accidentally relative asset requests from deep links
    # e.g. /staging/zh-TW/dashboard/assets/* -> /staging/assets/*
    location ~ ^/staging/.+/assets/(.+)$ {
        return 302 /staging/assets/$1;
    }

    # e.g. /staging/zh-TW/dashboard/tailwind.css -> /staging/tailwind.css
    location ~ ^/staging/.+/tailwind\.css$ {
        return 302 /staging/tailwind.css;
    }

    # Serve staging-prefixed static assets from root files
    location ^~ /staging/assets/ {
        rewrite ^/staging/(.*)$ /$1 break;
        try_files $uri =404;
    }

    location ^~ /staging/img/ {
        rewrite ^/staging/(.*)$ /$1 break;
        try_files $uri =404;
    }

    location = /staging/tailwind.css {
        try_files /tailwind.css =404;
    }

    location = /staging/manifest.json {
        try_files /manifest.json =404;
    }

    location = /staging/sw.js {
        try_files /sw.js =404;
    }

    location = /staging/favicon.ico {
        try_files /favicon.ico =404;
    }

    # SPA fallback for staging routes
    location /staging/ {
        try_files $uri $uri/ /index.html;
    }
}
